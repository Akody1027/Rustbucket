<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuralDrop | Driver Portal</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpSeGraT4Oee7tU5WjCfPr9Dskd0smdmU"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        [v-cloak] { display: none; }
        #driver-map { height: 450px; width: 100%; border-bottom: 4px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 antialiased font-sans">

<div id="app" v-cloak>
    <div v-if="!isAuthenticated" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-md">
            <h2 class="text-3xl font-black mb-10 uppercase tracking-tighter">Driver Dashboard</h2>
            <input v-model="pinInput" type="password" maxlength="6" class="text-center text-4xl tracking-[0.4em] w-full border-b-4 border-slate-100 outline-none pb-4 mb-10 font-black">
            <button @click="login" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black shadow-xl">Unlock Dashboard</button>
        </div>
    </div>

    <main v-else class="min-h-screen pb-24">
        <div id="driver-map"></div>

        <div class="p-6 max-w-2xl mx-auto mt-4">
            <h3 class="font-black text-[10px] uppercase text-slate-400 tracking-widest mb-6">Active Deliveries</h3>
            <div v-for="(order, index) in orders" :key="order.id" class="p-6 bg-white rounded-3xl border border-slate-200 flex items-center gap-4 shadow-sm mb-4">
                <div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black">
                    {{ index + 1 }}
                </div>
                <div class="flex-1">
                    <h4 class="font-black text-sm text-slate-800">{{ order.customer || 'New Seeker' }}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest truncate">
                        {{ order.pickups[0].locationName }}
                    </p>
                </div>
                <button @click="completeOrder(order.id)" class="bg-green-100 text-green-600 px-5 py-2.5 rounded-xl font-black text-[10px] uppercase">
                    Delivered
                </button>
            </div>
            
            <div v-if="orders.length === 0" class="text-center py-20 opacity-20">
                <i class="fas fa-route text-6xl mb-4 text-slate-400"></i>
                <p class="font-black uppercase text-xs">Waiting for paid runs...</p>
            </div>
        </div>
    </main>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCgAjQPRCGAQEHyco2ORW6LdOv6yZ61nm0",
  authDomain: "rustbucketdelivery.firebaseapp.com",
  databaseURL: "https://rustbucketdelivery-default-rtdb.firebaseio.com",
  projectId: "rustbucketdelivery",
  storageBucket: "rustbucketdelivery.firebasestorage.app",
  messagingSenderId: "302970102953",
  appId: "1:302970102953:web:5b0024408461a83705b5b8",
  measurementId: "G-65JNM50N5N"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const { createApp } = Vue;

createApp({
    data() {
        return {
            isAuthenticated: false, pinInput: '',
            map: null, markers: [],
            driverLoc: { lat: 41.25, lng: -95.85 },
            orders: []
        }
    },
    methods: {
        login() {
            if(this.pinInput === '123456') {
                this.isAuthenticated = true;
                this.initMap();
                this.listen();
            } else { alert("Invalid PIN"); }
        },
        initMap() {
            setTimeout(() => {
                this.map = new google.maps.Map(document.getElementById("driver-map"), {
                    center: this.driverLoc,
                    zoom: 13,
                    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
                });
                
                // Get Live GPS
                navigator.geolocation.getCurrentPosition(pos => {
                    this.driverLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    this.map.setCenter(this.driverLoc);
                    this.draw();
                });
            }, 300);
        },
        listen() {
            db.ref('orders').on('value', snap => {
                const val = snap.val();
                this.orders = val ? Object.values(val) : [];
                this.draw();
            });
        },
        draw() {
            if(!this.map) return;
            // Clear current markers
            this.markers.forEach(m => m.setMap(null));
            this.markers = [];

            // Driver Home
            const driverMarker = new google.maps.Marker({
                position: this.driverLoc,
                map: this.map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#4f46e5", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
            });
            this.markers.push(driverMarker);

            this.orders.forEach(o => {
                const pickupPos = { lat: o.pickups[0].lat, lng: o.pickups[0].lng };
                const deliverPos = { lat: o.dLat, lng: o.dLng };

                // Pickup Marker
                const pMarker = new google.maps.Marker({ position: pickupPos, map: this.map, title: "Pickup" });
                this.markers.push(pMarker);

                // Delivery Marker
                const dMarker = new google.maps.Marker({ 
                    position: deliverPos, 
                    map: this.map, 
                    title: "Delivery",
                    label: { text: "D", color: "white", fontWeight: "bold" }
                });
                this.markers.push(dMarker);

                // Route Line (Pickup -> Delivery)
                const path = new google.maps.Polyline({
                    path: [pickupPos, deliverPos],
                    geodesic: true,
                    strokeColor: "#4f46e5",
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                });
                path.setMap(this.map);
            });
        },
        async completeOrder(id) {
            if(confirm("Mark as Delivered?")) {
                await db.ref('orders/' + id).remove();
            }
        }
    }
}).mount('#app');
</script>
</body>
</html>
