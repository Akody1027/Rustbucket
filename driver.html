<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuralDrop | Driver Command</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        [v-cloak] { display: none; }
        #map { height: 400px; width: 100%; z-index: 1; border-bottom: 4px solid #4f46e5; }
        .tab-active { color: #4f46e5; border-bottom: 4px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 antialiased font-sans">

<div id="app" v-cloak>
    <div v-if="!isAuthenticated" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-md">
            <div class="bg-slate-900 text-white w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-steering-wheel"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 uppercase tracking-tighter">Driver Portal</h2>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-10">Enter 6-Digit PIN</p>
            
            <input v-model="pinInput" type="password" maxlength="6" 
                   class="text-center text-4xl tracking-[0.4em] w-full border-b-4 border-slate-100 focus:border-indigo-600 outline-none pb-4 mb-10 font-black">
            
            <button @click="login" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black shadow-xl hover:bg-indigo-600 transition-all">
                Unlock Dashboard
            </button>
        </div>
    </div>

    <main v-else class="min-h-screen pb-24">
        <div id="map"></div>

        <div class="bg-white flex border-b sticky top-0 z-40 shadow-sm">
            <button @click="activeTab = 'current'" :class="activeTab === 'current' ? 'tab-active' : 'text-slate-400'" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest">Active Run</button>
            <button @click="activeTab = 'settings'" :class="activeTab === 'settings' ? 'tab-active' : 'text-slate-400'" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest">Settings</button>
        </div>

        <div class="p-4 max-w-2xl mx-auto mt-4">
            <div v-if="activeTab === 'current'" class="space-y-4">
                <div v-for="(order, index) in orders" :key="order.id" class="p-6 bg-white rounded-3xl border border-slate-200 flex items-center gap-4 shadow-sm">
                    <div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black">
                        {{ index + 1 }}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-black text-slate-800">{{ order.customer || 'New Seeker' }}</h4>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            ${{ order.total }}.00 â€¢ {{ order.pickups.length }} Stops
                        </p>
                    </div>
                    <button @click="completeOrder(order.id)" class="bg-green-100 text-green-600 px-5 py-2.5 rounded-xl font-black text-[10px] uppercase">
                        Delivered
                    </button>
                </div>

                <div v-if="orders.length === 0" class="text-center py-20 opacity-20">
                    <i class="fas fa-route text-6xl mb-4"></i>
                    <p class="font-black uppercase text-xs">Scanning for active paid orders...</p>
                </div>
            </div>

            <div v-if="activeTab === 'settings'" class="text-center space-y-6">
                <div class="bg-white p-10 rounded-[3rem] border shadow-sm">
                    <h3 class="font-black text-slate-800 uppercase tracking-widest mb-2">Driver Account</h3>
                    <p class="text-xs text-slate-400 font-bold mb-8 uppercase">ID: RB-{{ pinInput }}</p>
                    <button @click="logout" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-black text-xs uppercase">Sign Out</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Your specific Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCgAjQPRCGAQEHyco2ORW6LdOv6yZ61nm0",
  authDomain: "rustbucketdelivery.firebaseapp.com",
  databaseURL: "https://rustbucketdelivery-default-rtdb.firebaseio.com",
  projectId: "rustbucketdelivery",
  storageBucket: "rustbucketdelivery.firebasestorage.app",
  messagingSenderId: "302970102953",
  appId: "1:302970102953:web:5b0024408461a83705b5b8",
  measurementId: "G-65JNM50N5N"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const { createApp } = Vue;

createApp({
    data() {
        return {
            isAuthenticated: false,
            pinInput: '',
            activeTab: 'current',
            map: null,
            driverLoc: [41.25716, -95.99510], // Omaha default
            orders: []
        }
    },
    methods: {
        login() {
            if(this.pinInput === '123456') {
                this.isAuthenticated = true;
                this.initMap();
                this.listenForOrders();
            } else { alert("Invalid Driver PIN"); }
        },
        initMap() {
            setTimeout(() => {
                if (this.map) this.map.remove();
                this.map = L.map('map', { zoomControl: false }).setView(this.driverLoc, 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                
                // Get real location if available
                navigator.geolocation.getCurrentPosition(pos => {
                    this.driverLoc = [pos.coords.latitude, pos.coords.longitude];
                    this.map.setView(this.driverLoc, 13);
                    this.drawRoutes();
                });
            }, 300);
        },
        listenForOrders() {
            db.ref('orders').on('value', snap => {
                const val = snap.val();
                this.orders = val ? Object.values(val) : [];
                this.drawRoutes();
            });
        },
        drawRoutes() {
            if (!this.map) return;
            // Clear current map markers
            this.map.eachLayer(l => { if (l instanceof L.Polyline || l instanceof L.Marker || l instanceof L.CircleMarker) this.map.removeLayer(l); });
            
            // Driver location icon
            L.marker(this.driverLoc, {
                icon: L.divIcon({className: 'bg-indigo-600 w-4 h-4 rounded-full border-2 border-white shadow-lg'})
            }).addTo(this.map);

            let lastPoint = this.driverLoc;

            this.orders.forEach(order => {
                // 1. Pickups (Dotted Gray Line)
                if(order.pickups) {
                    order.pickups.forEach(p => {
                        if(p.lat) {
                            L.polyline([lastPoint, [p.lat, p.lng]], {color: '#94a3b8', weight: 2, dashArray: '5, 10'}).addTo(this.map);
                            L.circleMarker([p.lat, p.lng], {radius: 4, color: '#334155'}).addTo(this.map).bindPopup("Pickup: " + p.location);
                            lastPoint = [p.lat, p.lng];
                        }
                    });
                }
                // 2. Final Delivery (Solid Indigo Line)
                if(order.dLat) {
                    L.polyline([lastPoint, [order.dLat, order.dLng]], {color: '#4f46e5', weight: 5}).addTo(this.map);
                    L.circleMarker([order.dLat, order.dLng], {radius: 8, color: '#4f46e5', fillOpacity: 1}).addTo(this.map).bindPopup("Delivery: " + order.customer);
                    lastPoint = [order.dLat, order.dLng];
                }
            });
        },
        async completeOrder(id) {
            if(confirm("Mark as Delivered?")) {
                await db.ref('orders/' + id).remove();
            }
        },
        logout() {
            this.isAuthenticated = false;
            this.pinInput = '';
        }
    }
}).mount('#app');
</script>
</body>
</html>
