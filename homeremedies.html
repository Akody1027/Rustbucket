<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground X - Remedy Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        :root {
            --primary: #2563eb;
            --highlight: #fde047; /* Bright Yellow for highlights */
            --bg: #1e293b;
            --panel: #f8fafc;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Top Bar (The "Code Editor" Search) --- */
        .toolbar {
            background: white;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 10;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 600px;
        }

        #searchInput {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        #searchInput:focus {
            border-color: var(--primary);
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        button:disabled { opacity: 0.5; cursor: wait; }

        .status {
            color: #64748b;
            font-size: 0.9rem;
            margin-left: 15px;
            font-weight: 500;
        }

        /* --- Main Viewer Area --- */
        #viewerContainer {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }

        #pdfWrapper {
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        canvas {
            display: block;
            border-radius: 4px;
        }

        /* --- The Highlight Overlay Layer --- */
        #highlightLayer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Let clicks pass through to PDF */
        }

        .highlight-box {
            position: absolute;
            background-color: var(--highlight);
            opacity: 0.4; /* Transparent yellow */
            border: 1px solid #eab308;
            border-radius: 2px;
        }

        /* Navigation Buttons */
        .nav-controls {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="nav-controls">
            <button onclick="changePage(-1)">Previous</button>
            <span id="pageInfo" style="align-self: center; font-weight: bold; color: #334155;">Page 1</span>
            <button onclick="changePage(1)">Next</button>
        </div>

        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Search remedy (e.g. 'Headache' or 'Ginger')..." onkeydown="if(event.key === 'Enter') searchPDF()">
        </div>
        <button onclick="searchPDF()">Search</button>
        <div class="status" id="searchStatus">Ready</div>
    </div>

    <div id="viewerContainer">
        <div id="pdfWrapper">
            <canvas id="the-canvas"></canvas>
            <div id="highlightLayer"></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const url = 'Homeremedies.pdf'; // Ensure file name matches exactly
    
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.5; // Zoom level
    const canvas = document.getElementById('the-canvas');
    const ctx = canvas.getContext('2d');
    const highlightLayer = document.getElementById('highlightLayer');
    const statusDiv = document.getElementById('searchStatus');

    // Load the PDF
    pdfjsLib.getDocument(url).promise.then((pdfDoc_) => {
        pdfDoc = pdfDoc_;
        document.getElementById('pageInfo').innerText = `Page 1 of ${pdfDoc.numPages}`;
        renderPage(pageNum);
    }).catch(err => {
        console.error("Error loading PDF:", err);
        statusDiv.innerText = "Error: Could not load 'Homeremedies.pdf'. Is it in the same folder?";
        statusDiv.style.color = "red";
    });

    /**
     * Render the page and the highlight layer
     */
    function renderPage(num) {
        pageRendering = true;
        
        // 1. Fetch Page
        pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            // Adjust overlay layer size to match
            highlightLayer.style.width = `${viewport.width}px`;
            highlightLayer.style.height = `${viewport.height}px`;
            highlightLayer.innerHTML = ''; // Clear previous highlights

            // 2. Render PDF to Canvas
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            const renderTask = page.render(renderContext);

            // Wait for render to finish
            renderTask.promise.then(() => {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                
                // 3. Re-apply highlights if a search term exists
                const searchTerm = document.getElementById('searchInput').value;
                if(searchTerm.length > 2) {
                    highlightTextOnPage(page, viewport, searchTerm);
                }
            });
        });

        // Update Page Counters
        document.getElementById('pageInfo').innerText = `Page ${num} of ${pdfDoc.numPages}`;
    }

    /**
     * Navigation Logic
     */
    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function changePage(offset) {
        if (pageNum + offset >= 1 && pageNum + offset <= pdfDoc.numPages) {
            pageNum += offset;
            queueRenderPage(pageNum);
        }
    }

    /**
     * SEARCH LOGIC: The "Code Editor" Feature
     */
    async function searchPDF() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!query) return;

        statusDiv.innerText = "Scanning 300 pages... (Please wait)";
        
        // Loop through all pages to find the first match
        // Note: For a production app, we would index this once at startup.
        // For a single file, we scan on demand.
        
        let found = false;

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const textContent = await page.getTextContent();
            const textItems = textContent.items;
            
            // Combine text items to check for the phrase
            const pageText = textItems.map(item => item.str).join(' ').toLowerCase();
            
            if (pageText.includes(query)) {
                pageNum = i;
                queueRenderPage(pageNum);
                statusDiv.innerText = `Found "${query}" on Page ${i}`;
                found = true;
                break; // Stop at first match
            }
        }

        if (!found) {
            statusDiv.innerText = `"${query}" not found in document.`;
        }
    }

    /**
     * HIGHLIGHT LOGIC: Coordinate Mapping
     */
    async function highlightTextOnPage(page, viewport, query) {
        const textContent = await page.getTextContent();
        const textItems = textContent.items;
        const searchStr = query.toLowerCase();

        // Loop through every text snippet on the page
        for (let i = 0; i < textItems.length; i++) {
            const item = textItems[i];
            const itemStr = item.str.toLowerCase();

            if (itemStr.includes(searchStr)) {
                // We found the word! Now we need its coordinates.
                // PDF.js gives coordinates in [x, y, w, h] usually via transform matrix
                
                // item.transform is [scaleX, skewY, skewX, scaleY, x, y]
                // PDF coordinates start from Bottom-Left, HTML is Top-Left. 
                // Viewport.convertToViewportRectangle handles this math for us.
                
                // We estimate width/height based on font size if width isn't explicit
                const tx = item.transform;
                
                // Construct a rectangle for the word. 
                // Note: accurate width calculation is complex, we will approximate for the visual effect
                const fontHeight = Math.sqrt(tx[2] * tx[2] + tx[3] * tx[3]);
                const fontWidth = item.width; 
                
                // PDF Rect: [x, y, x + w, y + h]
                // Note: PDF y is 0 at bottom.
                const pdfRect = [
                    tx[4], 
                    tx[5], 
                    tx[4] + item.width, 
                    tx[5] + (item.height || fontHeight) // Use font height if item height is 0
                ];

                // Convert to Canvas Coordinates
                const rect = viewport.convertToViewportRectangle(pdfRect);
                
                // Create the Highlight Div
                // rect is [x1, y1, x2, y2]
                const div = document.createElement('div');
                div.className = 'highlight-box';
                
                // Calculate position (Normalization for HTML coordinate system)
                const x = Math.min(rect[0], rect[2]);
                const y = Math.min(rect[1], rect[3]);
                const w = Math.abs(rect[0] - rect[2]);
                const h = Math.abs(rect[1] - rect[3]);

                div.style.left = `${x}px`;
                div.style.top = `${y - h}px`; // Adjust for baseline
                div.style.width = `${w}px`;
                div.style.height = `${h}px`;

                highlightLayer.appendChild(div);
            }
        }
    }
</script>

</body>
</html>
